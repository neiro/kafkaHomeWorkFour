# Настройка защищённого соединения и управление доступом

## 1. Обзор

В данном проекте демонстрируется:

- Настройка кластера Kafka из трёх брокеров (`kafka1`, `kafka2`, `kafka3`) и Zookeeper с использованием Docker Compose.
- Генерация корневого сертификата и сертификатов для каждого брокера (Keystore/Truststore).
- Настройка SSL (SASL_SSL) для безопасного соединения с брокерами.
- Создание топиков `topic-1` и `topic-2`.
- Управление правами доступа (ACL), при котором:
  - `topic-1`: доступен для продюсеров и консьюмеров.
  - `topic-2`: доступен только для продюсеров (чтение/доступ консьюмерам запрещён).
- Проверка отправки и чтения (или отсутствия чтения) сообщений через встроенные продюсер и консьюмер (Spring Boot-приложение).

## 2. Содержимое репозитория

- **docker-compose.yml**  
  Главный файл конфигурации контейнеров (Zookeeper, три брокера Kafka, утилита для генерации сертификатов `cert-generator` и Java-приложение `kafka-acl-init`).

- **certs/**  
  Папка для хранения сгенерированных сертификатов (Truststore и Keystore для каждого брокера, а также для продюсера).

- **entrypoint_kafka.sh**, **wait-for-certs.sh**, **wait-for-kafka.sh**  
  Скрипты, обеспечивающие:
  - ожидание готовности сертификатов;
  - ожидание корректного запуска брокеров Kafka;
  - запуск Kafka с учётом SSL и SASL настроек.

- **pom.xml** и **java-исходники** (пакеты `com.example.kafkainit`)  
  Spring Boot-приложение (модуль `kafka-acl-init`), которое при запуске:
  - Создаёт требуемые топики (`topic-1`, `topic-2`).
  - Настраивает ACL (права доступа).
  - Тестирует отправку/чтение сообщений через продюсер/консьюмер.

- **application.yaml**  
  Конфигурация Spring Boot (подключение к Kafka, SSL-свойства, механизмы SASL и т.д.).

- **Файлы конфигурации JAAS**  
  Подключаются брокерами для аутентификации (SASL PLAIN) и авторизации (ACL).

## 3. Основные шаги настройки

### Шаг 1. Генерация сертификатов

В директории `certs/` запускается контейнер `cert-generator` из `docker-compose.yml`, который:

- Создаёт корневой сертификат (CA).
- Генерирует Keystore/Truststore для каждого брокера (`kafka1`, `kafka2`, `kafka3`) и клиента (`producer`).
- Выкладывает готовые `.jks`-файлы и метку `done.txt` для сигнала о завершении.

### Шаг 2. Запуск кластера Kafka и Zookeeper с SSL

- Zookeeper запускается с параметрами SASL и принудительной аутентификацией.
- Kafka-брокеры имеют:
  - SSL-конфигурацию (Keystore и Truststore).
  - `KAFKA_OPTS` указывают на конфигурационные файлы JAAS, чтобы активировать механизм SASL/PLAIN.
  - Параметры `KAFKA_SASL_ENABLED_MECHANISMS` и `KAFKA_SASL_MECHANISM_INTER_BROKER_PROTOCOL` определяют, как брокеры общаются друг с другом по SSL + SASL.

### Шаг 3. ACL и топики

Приложение `kafka-acl-init` (Java/Spring Boot) при старте выполняет:

- Создание топиков `topic-1` и `topic-2` (при необходимости, с несколькими репликами/партициями).
- Назначение прав доступа:
  - `topic-1`: ALLOW для READ/WRITE и DESCRIBE.
  - `topic-2`: ALLOW для WRITE, но без READ (консьюмеры не могут читать).
- Тестирование: отправка сообщений в оба топика, чтение из `topic-1` (разрешено), попытка чтения из `topic-2` (должна блокироваться ACL).

## 4. Как запустить

1. Клонируйте репозиторий:

```bash
    git clone https://github.com/neiro/kafkaHomeWorkFour
    cd kafkaHomeWorkFour
```
2. Запустите Docker Compose:

```bash
    docker-compose up --build
```

Контейнер cert-generator сгенерирует сертификаты.

Zookeeper и три брокера Kafka поднимутся с SSL/SASL-настройками.

Java-приложение kafka-acl-init автоматически создаст топики и ACL, затем протестирует продюсер/консьюмер.

3. Убедитесь, что всё поднялось:

В логах должно отобразиться успешное создание топиков topic-1 и topic-2.

ACL проставлены, и сообщение об успехе.

Producer отправляет сообщения в оба топика, Consumer читает из topic-1 и НЕ может читать topic-2.


   ## 5. Как проверить вручную

После успешного старта вы можете проверить работоспособность топиков и ACL любым удобным клиентом Kafka (например, консольными утилитами `kafka-console-producer`/`kafka-console-consumer`), указав SSL-свойства. Или воспользоваться REST-эндпоинтами из Spring Boot-приложения (например, `POST /api/send?topic=topic-1&key=foo&message=bar`).

## 6. Структура сертификатов

В папке `certs/` создаются следующие файлы:

- `ca-cert`, `ca-key` – корневой сертификат и ключ CA.
- `kafka1/`, `kafka2/`, `kafka3/`, `producer/` – индивидуальные keystore/truststore (`.keystore.jks`, `.truststore.jks`), а также служебные `done.txt`, указывающие, что сертификаты готовы.

## 7. Итоги

- Настроен трёхброкерный кластер Kafka с SSL (SASL_SSL).
- Созданы топики `topic-1` и `topic-2`, проверен доступ:
  - `topic-1`: доступен для чтения и записи.
  - `topic-2`: доступен только для записи.
- Готовые сертификаты можно перенести на другой компьютер для запуска аналогичного окружения.
